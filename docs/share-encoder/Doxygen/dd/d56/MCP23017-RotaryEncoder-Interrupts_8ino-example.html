<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Control Surface: MCP23017-RotaryEncoder-Interrupts.ino</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script>
<script type="text/javascript" async="async" src="/MathJax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../custom_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Control Surface
   <span id="projectnumber">&#160;<code><a href="/Control-Surface-doc/">share-encoder</a></code></span>
   </div>
   <div id="projectbrief">MIDI Control Surface library for Arduino</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MCP23017-RotaryEncoder-Interrupts.ino</div>  </div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="autotoc_md31"></a>
MCP23017-RotaryEncoder-Interrupts</h1>
<p>This example demonstrates the use of MCP23017 I²C port expanders with rotary encoders that send relative Control Change messages, using hardware interrupts so you don't miss any pulses.</p>
<dl class="section user"><dt>Boards:</dt><dd>Teensy 3.x</dd></dl>
<p>This only works on Teensy boards, and maybe on other ARM boards. <br  />
 I've tested it using a Teensy 3.2 and a Teensy 4.0.</p>
<p>AVR boards (Arduino Uno, Mega, etc.) don't support I²C inside of interrupt service routines, so there's no way to read the state of the MCP23017 inside of an ISR. <br  />
 The same goes for ESP32 and ESP8266, although there may be ways around this by using alternative I²C drivers or by using FreeRTOS features.</p>
<h2><a class="anchor" id="autotoc_md32"></a>
Connections</h2>
<ul>
<li>SDA: MCP23017 SDA</li>
<li>SCL: MCP23017 SCL</li>
<li>12: MCP23017 INTA or INTB</li>
</ul>
<p>Connect up to 8 encoders to the MCP23017's GPIO pins: the first encoder connects to GPIO A0 and A1, the second encoder connects to GPIO A2 and A3, ..., the eighth encoder connects to GPIO B6 and B7. <br  />
 Connect the "common" pins of the encoders to ground. <br  />
 The built-in pull-up resistors of the MCP23017 will be enabled.</p>
<p>Make sure that the reset and address pins are all configured correctly (reset to Vcc; A0, A1 and A2 to ground).</p>
<p>If you need more than one MCP23017 with encoders, you can connect their interrupt pins together. This does result in higher latency, because on average, half of the total number of MCP23017s have to be polled, which is relatively slow, and might lead to missed pulses when using a large number of encoders.</p>
<h2><a class="anchor" id="autotoc_md33"></a>
Behavior</h2>
<p>When the position of one of the encoders changes, a relative Control Change message is sent.</p>
<h2><a class="anchor" id="autotoc_md34"></a>
Mapping</h2>
<p>Map the Arduino as a Mackie Control Universal in your DAW. The encoders will control the pan (just like the V-Pots on an <a class="el" href="../../d7/dc7/namespaceMCU.html">MCU</a>).</p>
<p>The interrupt pin of the MCP23017 triggers a hardware interrupt on the Arduino. This means that you don't have to manually poll the encoders all the time.</p>
<p>Written by PieterP, 2020-04-06 <br  />
 <a href="https://github.com/tttapa/Arduino-Helpers">https://github.com/tttapa/Arduino-Helpers</a></p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/dbf/Control__Surface_8h.html">Control_Surface.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d8/dd2/MCP23017Encoders_8hpp.html">AH/Hardware/MCP23017Encoders.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/d50/Abstract_2MIDIRotaryEncoder_8hpp.html">MIDI_Outputs/Abstract/MIDIRotaryEncoder.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;Wire.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Type for the MCP23017 encoders (translates encoder pulses to position)</span></div>
<div class="line"><span class="keyword">using</span> WireType = decltype(Wire);     <span class="comment">// The type of I²C driver to use</span></div>
<div class="line"><span class="keyword">using</span> EncoderPositionType = int32_t; <span class="comment">// The type for saving encoder positions</span></div>
<div class="line">constexpr <span class="keywordtype">bool</span> IntSafe = <span class="keyword">true</span>;       <span class="comment">// Make it safe to call `update` in an ISR</span></div>
<div class="line"><span class="keyword">using</span> MCPEncoderType = MCP23017Encoders&lt;WireType, EncoderPositionType, IntSafe&gt;;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Type for the MIDI encoders (translates position to MIDI messages)</span></div>
<div class="line"><span class="keyword">struct </span>CCMCPEncoder : <a name="_a0"></a><a class="code" href="../../d0/d9e/classGenericMIDIRotaryEncoder.html">GenericMIDIRotaryEncoder</a>&lt;MCPEncoderType::MCP23017Encoder, </div>
<div class="line">                                               RelativeCCSender&gt; {</div>
<div class="line">  CCMCPEncoder(MCPEncoderType::MCP23017Encoder enc, <a name="_a1"></a><a class="code" href="../../d7/d0f/classMIDIAddress.html">MIDIAddress</a> address, </div>
<div class="line">               int16_t multiplier = 1, uint8_t pulsesPerStep = 4)</div>
<div class="line">    : <a class="code" href="../../d0/d9e/classGenericMIDIRotaryEncoder.html">GenericMIDIRotaryEncoder</a>(<a class="code" href="../../d8/dcc/namespacestd.html">std</a>::move(enc), address, multiplier, </div>
<div class="line">                               pulsesPerStep, {}) {}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a name="_a2"></a><a class="code" href="../../de/d2d/classUSBDebugMIDI__Interface.html">USBDebugMIDI_Interface</a> midi;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> uint8_t interrupt_pin = 12;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create an object that manages the 8 encoders connected to the MCP23017.</span></div>
<div class="line">MCPEncoderType enc = {Wire, 0x0, interrupt_pin};</div>
<div class="line"><span class="comment">//                    │     │    └─ Interrupt pin</span></div>
<div class="line"><span class="comment">//                    │     └────── Address offset</span></div>
<div class="line"><span class="comment">//                    └──────────── I²C interface</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Instantiate 8 MIDI rotary encoders.</span></div>
<div class="line">CCMCPEncoder ccencoders[] = {</div>
<div class="line">  {</div>
<div class="line">    enc[0],       <span class="comment">// The encoder to use</span></div>
<div class="line">    <a name="a3"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#ga9400848eec9735623e1502aef5bb7cb3">MCU::V_POT_1</a>, <span class="comment">// The MIDI address</span></div>
<div class="line">    1,            <span class="comment">// Encoder speed multiplier</span></div>
<div class="line">    4,            <span class="comment">// Number of pulses per physical &quot;click&quot; of the encoder</span></div>
<div class="line">  },</div>
<div class="line">  {enc[1], <a name="a4"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#ga92a2c8cd9cbff4a39644e3d056a8d4f2">MCU::V_POT_2</a>},</div>
<div class="line">  {enc[2], <a name="a5"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#gae2f0151f08f23de10baefa5569fe5f43">MCU::V_POT_3</a>},</div>
<div class="line">  {enc[3], <a name="a6"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#gaf8267cd2589cdf181931744188583a25">MCU::V_POT_4</a>},</div>
<div class="line">  {enc[4], <a name="a7"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#ga35d2436eb27c2895c585b665167a0f1b">MCU::V_POT_5</a>},</div>
<div class="line">  {enc[5], <a name="a8"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#gac6ecffbdbfd1a0f59d3894932806e354">MCU::V_POT_6</a>},</div>
<div class="line">  {enc[6], <a name="a9"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#ga965a18e233916727bb793a7c777603f7">MCU::V_POT_7</a>},</div>
<div class="line">  {enc[7], <a name="a10"></a><a class="code" href="../../d0/d7e/group__MCU__CC.html#gaa315e61ff0ceca932be00db242990090">MCU::V_POT_8</a>},</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> isr() {</div>
<div class="line">  enc.update(); <span class="comment">// Read the state of the encoders and update the positions</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">  <a name="a11"></a><a class="code" href="../../d9/d38/Control__Surface__Class_8cpp.html#af7a5d250297d82b2b29605dd7ac250df">Control_Surface</a>.<a name="a12"></a><a class="code" href="../../dc/d45/classControl__Surface__.html#ab0bdf5cca484fb2ba637c39384b27fb2">begin</a>();</div>
<div class="line">  Wire.begin(); <span class="comment">// Must be called before enc.begin()</span></div>
<div class="line">  Wire.setClock(800000);</div>
<div class="line">  enc.begin(); <span class="comment">// Initialize the MCP23017</span></div>
<div class="line">  attachInterrupt(digitalPinToInterrupt(interrupt_pin), isr, <a name="a13"></a><a class="code" href="../../dd/ddf/ExtendedInputOutput_8hpp.html#ad294464395ca0655395db09e768fdc1d">LOW</a>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">  <span class="comment">// No `enc.update()` here, updating the encoders happens inside of the ISR</span></div>
<div class="line">  <a class="code" href="../../d9/d38/Control__Surface__Class_8cpp.html#af7a5d250297d82b2b29605dd7ac250df">Control_Surface</a>.<a name="a14"></a><a class="code" href="../../dc/d45/classControl__Surface__.html#afe461d27b9c48d5921c00d521181f12f">loop</a>();</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="aExtendedInputOutput_8hpp_html_ad294464395ca0655395db09e768fdc1d"><div class="ttname"><a href="../../dd/ddf/ExtendedInputOutput_8hpp.html#ad294464395ca0655395db09e768fdc1d">LOW</a></div><div class="ttdeci">const PinStatus_t LOW</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/ddf/ExtendedInputOutput_8hpp_source.html#l00057">ExtendedInputOutput.hpp:57</a></div></div>
<div class="ttc" id="aAbstract_2MIDIRotaryEncoder_8hpp_html"><div class="ttname"><a href="../../db/d50/Abstract_2MIDIRotaryEncoder_8hpp.html">MIDIRotaryEncoder.hpp</a></div></div>
<div class="ttc" id="aclassMIDIAddress_html"><div class="ttname"><a href="../../d7/d0f/classMIDIAddress.html">MIDIAddress</a></div><div class="ttdoc">A type-safe utility class for saving a MIDI address consisting of a 7-bit address,...</div><div class="ttdef"><b>Definition:</b> <a href="../../db/dd6/MIDIAddress_8hpp_source.html#l00088">MIDIAddress.hpp:88</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_gaf8267cd2589cdf181931744188583a25"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#gaf8267cd2589cdf181931744188583a25">MCU::V_POT_4</a></div><div class="ttdeci">constexpr uint8_t V_POT_4</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00162">MCU.hpp:162</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_ga965a18e233916727bb793a7c777603f7"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#ga965a18e233916727bb793a7c777603f7">MCU::V_POT_7</a></div><div class="ttdeci">constexpr uint8_t V_POT_7</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00165">MCU.hpp:165</a></div></div>
<div class="ttc" id="aMCP23017Encoders_8hpp_html"><div class="ttname"><a href="../../d8/dd2/MCP23017Encoders_8hpp.html">MCP23017Encoders.hpp</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_ga92a2c8cd9cbff4a39644e3d056a8d4f2"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#ga92a2c8cd9cbff4a39644e3d056a8d4f2">MCU::V_POT_2</a></div><div class="ttdeci">constexpr uint8_t V_POT_2</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00160">MCU.hpp:160</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_gaa315e61ff0ceca932be00db242990090"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#gaa315e61ff0ceca932be00db242990090">MCU::V_POT_8</a></div><div class="ttdeci">constexpr uint8_t V_POT_8</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00166">MCU.hpp:166</a></div></div>
<div class="ttc" id="aControl__Surface_8h_html"><div class="ttname"><a href="../../db/dbf/Control__Surface_8h.html">Control_Surface.h</a></div><div class="ttdoc">The main header file that includes all Control-Surface header files.</div></div>
<div class="ttc" id="aclassControl__Surface___html_afe461d27b9c48d5921c00d521181f12f"><div class="ttname"><a href="../../dc/d45/classControl__Surface__.html#afe461d27b9c48d5921c00d521181f12f">Control_Surface_::loop</a></div><div class="ttdeci">void loop()</div><div class="ttdoc">Update all MIDI elements, send MIDI events and read MIDI input.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d38/Control__Surface__Class_8cpp_source.html#l00068">Control_Surface_Class.cpp:68</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_ga9400848eec9735623e1502aef5bb7cb3"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#ga9400848eec9735623e1502aef5bb7cb3">MCU::V_POT_1</a></div><div class="ttdeci">constexpr uint8_t V_POT_1</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00159">MCU.hpp:159</a></div></div>
<div class="ttc" id="aControl__Surface__Class_8cpp_html_af7a5d250297d82b2b29605dd7ac250df"><div class="ttname"><a href="../../d9/d38/Control__Surface__Class_8cpp.html#af7a5d250297d82b2b29605dd7ac250df">Control_Surface</a></div><div class="ttdeci">Control_Surface_ &amp; Control_Surface</div><div class="ttdoc">A predefined instance of the Control Surface to use in the Arduino sketches.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d38/Control__Surface__Class_8cpp_source.html#l00198">Control_Surface_Class.cpp:198</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_ga35d2436eb27c2895c585b665167a0f1b"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#ga35d2436eb27c2895c585b665167a0f1b">MCU::V_POT_5</a></div><div class="ttdeci">constexpr uint8_t V_POT_5</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00163">MCU.hpp:163</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_gae2f0151f08f23de10baefa5569fe5f43"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#gae2f0151f08f23de10baefa5569fe5f43">MCU::V_POT_3</a></div><div class="ttdeci">constexpr uint8_t V_POT_3</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00161">MCU.hpp:161</a></div></div>
<div class="ttc" id="anamespacestd_html"><div class="ttname"><a href="../../d8/dcc/namespacestd.html">std</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d4/d1b/vector_8cpp_source.html#l00005">vector.cpp:5</a></div></div>
<div class="ttc" id="aclassGenericMIDIRotaryEncoder_html"><div class="ttname"><a href="../../d0/d9e/classGenericMIDIRotaryEncoder.html">GenericMIDIRotaryEncoder</a></div><div class="ttdoc">An abstract class for rotary encoders that send MIDI events.</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d50/Abstract_2MIDIRotaryEncoder_8hpp_source.html#l00016">Abstract/MIDIRotaryEncoder.hpp:16</a></div></div>
<div class="ttc" id="agroup__MCU__CC_html_gac6ecffbdbfd1a0f59d3894932806e354"><div class="ttname"><a href="../../d0/d7e/group__MCU__CC.html#gac6ecffbdbfd1a0f59d3894932806e354">MCU::V_POT_6</a></div><div class="ttdeci">constexpr uint8_t V_POT_6</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d60/MCU_8hpp_source.html#l00164">MCU.hpp:164</a></div></div>
<div class="ttc" id="aclassUSBDebugMIDI__Interface_html"><div class="ttname"><a href="../../de/d2d/classUSBDebugMIDI__Interface.html">USBDebugMIDI_Interface</a></div><div class="ttdoc">A class for debug MIDI interfaces sending and receiving human-readable MIDI messages over the USB CDC...</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d55/DebugMIDI__Interface_8hpp_source.html#l00115">DebugMIDI_Interface.hpp:116</a></div></div>
<div class="ttc" id="aclassControl__Surface___html_ab0bdf5cca484fb2ba637c39384b27fb2"><div class="ttname"><a href="../../dc/d45/classControl__Surface__.html#ab0bdf5cca484fb2ba637c39384b27fb2">Control_Surface_::begin</a></div><div class="ttdeci">void begin()</div><div class="ttdoc">Initialize the Control_Surface.</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d38/Control__Surface__Class_8cpp_source.html#l00025">Control_Surface_Class.cpp:25</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
